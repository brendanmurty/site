---
title: Search
layout: layouts/page.layout.njk
body_class: page-search
---

<h2>Search Posts</h2>

<form id="search-form" class="search-form" role="search">
  <label for="search-input" class="visually-hidden">Search posts</label>
  <input
    type="search"
    id="search-input"
    class="search-input"
    placeholder="Search posts..."
    autocomplete="off"
  />
  <button type="submit" class="search-button">
    <span class="icon fa-fw fa-solid fa-magnifying-glass"></span>
    <span class="visually-hidden">Search</span>
  </button>
</form>

<div id="search-results" class="search-results">
  <p class="search-prompt">Enter a search term to find posts.</p>
</div>

<script>
(function() {
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  const searchForm = document.getElementById('search-form');
  let posts = [];
  let postsLoaded = false;
  let pendingQuery = null;

  // Fetch posts data from JSON feed
  fetch('/brendan/posts.json')
    .then(response => response.json())
    .then(data => {
      posts = data.items || [];
      postsLoaded = true;
      // If there was a pending query, execute it now
      if (pendingQuery !== null) {
        const results = searchPosts(pendingQuery);
        displayResults(results, pendingQuery);
        pendingQuery = null;
      }
    })
    .catch(error => {
      console.error('Error loading posts:', error);
      postsLoaded = true;
      searchResults.innerHTML = '<p class="search-error">Unable to load posts. Please try refreshing the page.</p>';
    });

  // Search function
  function searchPosts(query) {
    const normalizedQuery = query.toLowerCase().trim();
    if (!normalizedQuery) {
      return [];
    }

    return posts.filter(post => {
      const titleMatch = post.title && post.title.toLowerCase().includes(normalizedQuery);
      const contentMatch = post.content_text && post.content_text.toLowerCase().includes(normalizedQuery);
      return titleMatch || contentMatch;
    });
  }

  // Format date for display
  function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { day: 'numeric', month: 'short', year: 'numeric' };
    return date.toLocaleDateString('en-AU', options);
  }

  // Display results
  function displayResults(results, query) {
    if (!query.trim()) {
      searchResults.innerHTML = '<p class="search-prompt">Enter a search term to find posts.</p>';
      return;
    }

    if (results.length === 0) {
      searchResults.innerHTML = '<p class="search-no-results">No posts found matching "' + escapeHtml(query) + '".</p>';
      return;
    }

    const resultsHtml = results.map(post => {
      const date = formatDate(post.date_published);
      return `
        <li>
          <span class="post-date">${date}</span>
          <a class="post-link" href="${post.url}">${escapeHtml(post.title)}</a>
        </li>
      `;
    }).join('');

    searchResults.innerHTML = `
      <p class="search-count">Found ${results.length} post${results.length === 1 ? '' : 's'} matching "${escapeHtml(query)}".</p>
      <ul class="posts-list">${resultsHtml}</ul>
    `;
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Execute search (handles loading state)
  function executeSearch(query) {
    if (postsLoaded) {
      const results = searchPosts(query);
      displayResults(results, query);
    } else {
      pendingQuery = query;
      searchResults.innerHTML = '<p class="search-prompt">Loading posts...</p>';
    }
  }

  // Handle form submission
  searchForm.addEventListener('submit', function(e) {
    e.preventDefault();
    executeSearch(searchInput.value);
  });

  // Handle input changes (search as you type)
  let debounceTimer;
  searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(function() {
      executeSearch(searchInput.value);
    }, 300);
  });

  // Check for query parameter on page load
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get('q');
  if (initialQuery) {
    searchInput.value = initialQuery;
    executeSearch(initialQuery);
  }
})();
</script>
